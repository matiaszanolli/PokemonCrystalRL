<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Crystal RL Monitor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* Custom styles */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .metric-card {
            @apply bg-gray-800 rounded-lg p-4 shadow-lg;
        }
        .chart-container {
            @apply bg-gray-800 rounded-lg p-4 shadow-lg;
            min-height: 300px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <!-- Header -->
    <header class="bg-gray-800 py-4 px-6 flex justify-between items-center">
        <div class="flex items-center">
            <h1 class="text-2xl font-bold">Pokemon Crystal RL Monitor</h1>
            <span id="connectionStatus" class="ml-4 px-2 py-1 rounded text-sm"></span>
        </div>
        <div class="flex items-center space-x-4">
            <button id="pauseButton" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                Pause Updates
            </button>
            <button id="settingsButton" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                Settings
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto py-6">
        <!-- Game View -->
        <div class="grid-container">
            <!-- Game Screen -->
            <div class="col-span-2 bg-gray-800 rounded-lg p-4 shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Game Screen</h2>
                <img id="gameScreen" src="/static/loading.png" alt="Game Screen"
                     class="w-full rounded border-2 border-gray-700">
                <div class="mt-2 text-sm text-gray-400">
                    <span id="fpsCounter">0 FPS</span> |
                    <span id="framesSent">0 frames sent</span>
                </div>
            </div>

            <!-- Training Stats -->
            <div class="metric-card">
                <h2 class="text-xl font-semibold mb-4">Training Stats</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-gray-400">Episode</label>
                        <div id="episodeCounter" class="text-2xl font-bold">0</div>
                    </div>
                    <div>
                        <label class="text-gray-400">Total Steps</label>
                        <div id="stepCounter" class="text-2xl font-bold">0</div>
                    </div>
                    <div>
                        <label class="text-gray-400">Total Reward</label>
                        <div id="totalReward" class="text-2xl font-bold">0.0</div>
                    </div>
                </div>
            </div>

            <!-- Game Stats -->
            <div class="metric-card">
                <h2 class="text-xl font-semibold mb-4">Game Stats</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-gray-400">Pokemon</label>
                        <div id="pokemonCount" class="text-2xl font-bold">0</div>
                    </div>
                    <div>
                        <label class="text-gray-400">Badges</label>
                        <div id="badgeCount" class="text-2xl font-bold">0</div>
                    </div>
                    <div>
                        <label class="text-gray-400">Money</label>
                        <div id="moneyAmount" class="text-2xl font-bold">$0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid-container mt-6">
            <!-- Reward History -->
            <div class="chart-container col-span-2">
                <h2 class="text-xl font-semibold mb-4">Reward History</h2>
                <canvas id="rewardChart"></canvas>
            </div>

            <!-- Training Progress -->
            <div class="chart-container">
                <h2 class="text-xl font-semibold mb-4">Training Progress</h2>
                <canvas id="progressChart"></canvas>
            </div>
        </div>

        <!-- Actions and Events -->
        <div class="grid-container mt-6">
            <!-- Recent Actions -->
            <div class="bg-gray-800 rounded-lg p-4 shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Recent Actions</h2>
                <div id="actionLog" class="h-64 overflow-y-auto space-y-2">
                    <!-- Action log entries will be inserted here -->
                </div>
            </div>

            <!-- System Status -->
            <div class="bg-gray-800 rounded-lg p-4 shadow-lg">
                <h2 class="text-xl font-semibold mb-4">System Status</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-gray-400">CPU Usage</label>
                        <div class="relative pt-1">
                            <div id="cpuBar" class="resource-bar">
                                <div class="flex h-2 overflow-hidden bg-gray-700 rounded">
                                    <div class="progress-fill bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <div class="progress-value text-right mt-1 text-sm text-gray-400">0%</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-gray-400">Memory Usage</label>
                        <div class="relative pt-1">
                            <div id="memoryBar" class="resource-bar">
                                <div class="flex h-2 overflow-hidden bg-gray-700 rounded">
                                    <div class="progress-fill bg-green-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <div class="progress-value text-right mt-1 text-sm text-gray-400">0MB</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-gray-400">Network Traffic</label>
                        <div id="networkValue" class="text-sm text-gray-400">0 B/s</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
        <div class="absolute inset-1/4 bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400">Update Interval</label>
                    <input type="range" min="100" max="2000" step="100" value="1000"
                           id="updateInterval" class="w-full">
                    <div class="text-sm text-gray-400">
                        <span id="intervalValue">1000</span>ms
                    </div>
                </div>
                <div>
                    <label class="block text-gray-400">Frame Quality</label>
                    <select id="frameQuality" class="bg-gray-700 rounded px-2 py-1">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeSettings"
                            class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        let paused = false;
        let fpsCount = 0;
        let lastFpsUpdate = Date.now();

        // Chart configuration
        const rewardChart = new Chart(
            document.getElementById('rewardChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Reward',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            }
        );

        const progressChart = new Chart(
            document.getElementById('progressChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Experience',
                            data: [],
                            borderColor: 'rgb(16, 185, 129)',
                            tension: 0.1
                        },
                        {
                            label: 'Exploration',
                            data: [],
                            borderColor: 'rgb(249, 115, 22)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            }
        );

        // Socket.IO event handlers
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').classList.add('bg-green-600');
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').classList.add('bg-red-600');
        });

        socket.on('frame', (data) => {
            if (paused) return;
            document.getElementById('gameScreen').src = `data:image/png;base64,${data.data}`;
            fpsCount++;
        });

        socket.on('metrics', (data) => {
            if (paused) return;
            updateMetrics(data);
        });

        socket.on('status', (data) => {
            if (paused) return;
            updateStatus(data);
        });

        // Update functions
        function updateMetrics(data) {
            // Update metrics using shared utilities
            const metricMappings = {
                'episode': 'episodeCounter',
                'total_steps': 'stepCounter',
                'party_count': 'pokemonCount',
                'badges_total': 'badgeCount'
            };
            MonitoringUI.updateMetrics(data, metricMappings);
            
            // Special formatting for reward and money
            document.getElementById('totalReward').textContent =
                MonitoringUI.formatNumber(data.total_reward || 0, 2);
            document.getElementById('moneyAmount').textContent =
                `$${(data.money || 0).toLocaleString()}`;

            // Update charts
            if (data.reward_history) {
                const labels = data.reward_history.map((_, i) => i);
                const rewards = data.reward_history.map(r => r.value);

                rewardChart.data.labels = labels;
                rewardChart.data.datasets[0].data = rewards;
                rewardChart.update();
            }

            if (data.progress) {
                progressChart.data.labels = data.progress.map((_, i) => i);
                progressChart.data.datasets[0].data = data.progress.map(p => p.experience);
                progressChart.data.datasets[1].data = data.progress.map(p => p.exploration);
                progressChart.update();
            }
        }

        function updateStatus(data) {
            // Update system metrics
            MonitoringUI.updateResourceBar('cpuBar', data.cpu_percent, 100, 'formatNumber');
            MonitoringUI.updateResourceBar('memoryBar', data.memory_usage_mb, data.memory_total_mb, 'formatNumber');
            document.getElementById('networkValue').textContent =
                `${MonitoringUI.formatBytes(data.network_bytes_sec)}/s`;

            // Update FPS counter
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                document.getElementById('fpsCounter').textContent = `${fpsCount} FPS`;
                document.getElementById('framesSent').textContent =
                    `${data.frames_sent} frames sent`;
                fpsCount = 0;
                lastFpsUpdate = now;
            }
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
        }

        // Event listeners
        document.getElementById('pauseButton').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pauseButton').textContent =
                paused ? 'Resume Updates' : 'Pause Updates';
        });

        document.getElementById('settingsButton').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.remove('hidden');
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsModal').classList.add('hidden');
        });

        document.getElementById('updateInterval').addEventListener('input', (e) => {
            document.getElementById('intervalValue').textContent = e.target.value;
            socket.emit('set_interval', { interval: parseInt(e.target.value) });
        });

        document.getElementById('frameQuality').addEventListener('change', (e) => {
            socket.emit('set_quality', { quality: e.target.value });
        });

        // Initial setup
        setInterval(() => {
            if (!paused) {
                socket.emit('request_frame');
            }
        }, 1000 / 30);  // 30 FPS target
    </script>
</body>
</html>
